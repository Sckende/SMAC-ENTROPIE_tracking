---
title: "PTEBAR-JUV - Data explo"
author: "CCJ"
output:
  html_document:
    toc: true
    number_sections: true
    toc_float: true
---

```{r, include = F}
# Output figure in HTML5
if (knitr::is_html_output()) knitr::knit_hooks$set(
  plot = function(x, options) {
    cap  <- options$fig.cap  # figure caption
    tags <- htmltools::tags
    as.character(tags$figure(
      tags$img(src = x, alt = cap),
      tags$figcaption(cap)
    ))
  }
)

# packages
require(knitr)
require(mapview)
require(leafpop)
require(tidyverse)
require(dplyr)
require(sf)
require(lubridate)
require(htmltools)
```

```{css, echo = F}
.badCode {
background-color: red;
}

.goodCode {
  background-color: green;
}

.striped tbody tr:nth-children(even) {
  font-style: italic;
}
```

# Méthodologie  
 
Afin de comprendre et décrire le comportement des pétrels de Barau dans leurs premiers stades de vie, 19 balises ARGOS (5g avec panneau solaire, duty cycle **10/24**) ont été déployées sur des juvéniles prêts à l'envol (plumage complet), à partir de la colonie de reproduction du Grand Benare en 2017 et 2018.  
    
Les 6-7 avril 2017, 10 balises ARGOS ont été déployées. Huit individus ont été équipés à l'aide de tape **Tesa** et de glue **Loctite** et 2 individus, à l'aide d'un harnais en **Teflon**. Les oiseaux se sont envolés entre 2 & 13 jours (moy. 7 jours) après avoir été équipés.  
  
En 2018, 9 individus ont été équipés entre le 4 & 5 avril, tous avec un harnais en **Teflon**. Ils ont quitté la colonie dans les 2 à 8 jours (moy. 5.5 jours) qui ont suivis.  
  
  
```{r, echo = F}
tabb <- readRDS("C:/Users/ccjuhasz/Desktop/SMAC/Projet_publi/X-PTEBAR_argos_JUV/DATA/RMD/PTEBAR_JUV_infos_argos.rds")


kable(tabb, align = 'cccccccc')
```

# Résumé des données argos  
  
Les balises ont été programmées pour commencer à enregistrer les localisations AVANT leur déploiement. Il est donc nécessaire de retirer les localisations enregistrées avant la date de déploiement pour chaque balise.  
  
```{r, echo = F, class.source = 'test'}
tabb2 <- readRDS("C:/Users/ccjuhasz/Desktop/SMAC/Projet_publi/X-PTEBAR_argos_JUV/DATA/RMD/PTEBAR_JUV_Bilan_ARGOS_data.rds")[, c(1, 2, 4:8, 10:14)]



r <- apply(tabb2[, c(4:7, 9:10)],
           2,
           round,
           digits = 2)


tabb3 <- cbind(tabb2[, -c(4:7, 9:10)], r)

tabb3 <- tabb3[, c(6, 1:3, 7:10, 12, 4, 11, 5)]



kable(tabb3
#       , digits = 2
      , col.names = c('depYear','PTT', 'loc', 'dMax', 'maxLat', 'minLat', 'maxLon', 'minLon', 'distTrav', 'tripDay', 'maxDist', 'maxDistDay')
      , align = 'cccccccccccc'
#       # , table.attr = 'class=\"striped\"'
#       # , format = 'html'
      )
```
  
* **depYear** - Année de déploiement de la balise  
* **PTT** - Identifiant de la balise ARGOS  
* **loc** - Nombre de localisations enregistrées (sans les localisations de classe U et Z)  
* **dMax** - Dernière date où une localisation a été enregistrée  
* **max/minLat** - Latitude maximale et minimale  
* **max/minLon** - Longitude maximale et minimale  
* **distTrav** - Distance totale parcourue (km)  
* **tripDay** - Nombre de jours pour parcourir la distance totale  
* **maxDist** - Distance maximale atteinte par rapport à la colonie (km)  
* **maxDistDay** - Nombre de jours pour atteindre le point le plus éloigné par rapport à la colonie  
  
  
# Visualisation des trajets  
  
## Déploiement en 2017  
  
```{r, echo=F}

map_lines <- readRDS("C:/Users/ccjuhasz/Desktop/SMAC/Projet_publi/X-PTEBAR_argos_JUV/DATA/RMD/PTEBAR_JUV_Spatial_tracks_ARGOS.rds")

tabb3$PTT <- as.factor(tabb3$PTT)
tabb4 <- dplyr::left_join(map_lines, tabb3, by = 'PTT')


tabb4$popup_info <- paste0("<b>PTT</b> ",
                                 tabb4$PTT,
                                 "<br/>",
                                 "<b>Durée de l'enregistrement </b>",
                                 tabb4$duration_trip_day, " jours",
                                 "<br/>",
                                 "<b>Range latitude [</b>", tabb4$min_lat, "; ", tabb4$max_lat, "<b>]</b>",
                                 "<br/>",
                                 "<b>Range longitude [</b>", tabb4$min_lon, "; ", tabb4$max_lon, "<b>]</b>",
                           "</br>",
                           "<b>Distance maximale à la colonie </b>", tabb4$max_dist_km, " atteint km en ", tabb4$timing_for_max, " jours",
                           "</br>",
                           "<b>Distance totale parcourue </b>", tabb4$dist_travel_km, " km")

  mapview(tabb4[tabb4$dep_year == 2017,],
          zcol = 'PTT',
          burst = T,
          homebutton = F,
          popup = popupTable(tabb4[tabb4$dep_year == 2017,],
                             zcol = 'popup_info',
                             feature.id = FALSE,
                             row.numbers = FALSE,
                             className = 'mapview-popup')
          )
```  
  
## Déploiement en 2018  
  
```{r, echo=F}
    mapview(tabb4[tabb4$dep_year == 2018,],
          zcol = 'PTT',
          burst = T,
          homebutton = F,
          popup = popupTable(tabb4[tabb4$dep_year == 2018,],
                             zcol = 'popup_info',
                             feature.id = FALSE,
                             row.numbers = FALSE,
                             className = 'mapview-popup'))



```
  
## Points & trajet par individu  
  
```{r, echo=F}

argos <- readRDS("C:/Users/ccjuhasz/Desktop/SMAC/Projet_publi/X-PTEBAR_argos_JUV/DATA/PTEBAR_JUV_Pinet_data_CLEANED.rds")


argos.track <- do.call('rbind', argos) %>% group_by(Vessel) %>%  summarize(do_union = F) %>% st_cast('LINESTRING')

  x.plot <- lapply(argos, function(x){
    
    mapview(x,
        zcol = 'odd',
        col.regions = c('dodgerblue4', 'olivedrab'),
        popup = 'point.group',
        legend = F,
        layer.name = unique(as.character(x$Vessel))) + mapview(argos.track[argos.track$Vessel == unique(as.character(x$Vessel)),],
                                                               color = 'darkgrey',
                                                               layer.name = 'Track')
    
  })

  
x.plot[[1]]
x.plot[[2]]
x.plot[[3]]
x.plot[[4]]
x.plot[[5]]
x.plot[[6]]
x.plot[[7]]
x.plot[[8]]
x.plot[[9]]
x.plot[[10]]
x.plot[[11]]
x.plot[[12]]
x.plot[[13]]
x.plot[[14]]
x.plot[[15]]
```