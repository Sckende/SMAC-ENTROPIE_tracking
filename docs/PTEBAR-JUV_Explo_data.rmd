---
title: "PTEBAR-JUV - Data explo"
author: "CCJ"
output:
  html_document:
    toc: true
    number_sections: true
    toc_float: true
---

```{r, include = F}
# Output figure in HTML5
if (knitr::is_html_output()) knitr::knit_hooks$set(
  plot = function(x, options) {
    cap  <- options$fig.cap  # figure caption
    tags <- htmltools::tags
    as.character(tags$figure(
      tags$img(src = x, alt = cap),
      tags$figcaption(cap)
    ))
  }
)

# packages
require(knitr)
require(mapview)
require(leafpop)
require(tidyverse)
require(dplyr)
require(sf)
require(lubridate)
require(htmltools)
```

```{css, echo = F}
.badCode {
background-color: red;
}

.goodCode {
  background-color: green;
}

.striped tbody tr:nth-children(even) {
  font-style: italic;
}
```

# Méthodologie  
 
Duty cycle des balises ARGOS: 10/24
Le déploiement des balises ont eu lieu au cours de 2 périodes d'envol (2017 & 2018) sur des juvéniles issus de la colonie de pétrels de Barau du Grand Benare.  
  
Les 6-7 avril 2017, 10 balises ARGOS (5g, avec panneau solaire) ont été installées sur des juvéniles prêts à l'envol (plumage complet). 8 individus ont été équipé à l'aide de tape **Tesa** et de glue **Loctite** et 2 individus, à l'aide d'un harnais en **Teflon**. Les oiseaux se sont envolés entre 2 & 13 jours (moy. 7 jours) après avoir été équipé.  
En 2018, 9 individus ont été équipés entre le 4 & 5 avril, tous avec un harnais en **Teflon**. Ils ont quitté la colonie dans les 2 à 8 jours (moy. 5.5 jours) qui ont suivis.  
  
Les balises ont été programmées pour commencer à enregistrer les localisations AVANT leur déploiement (**start** < **deploy**). Il est donc nécessaire de retirer les localisations enregistrées avant la date de déploiement pour chaque balise. Présence d'informations non exactes (type d'attache & date de déploiement pour un individu) lors de la comparaison entre l'annexe du papier de Henri W. et les metadonnées du Life.  
Les données présentées ici, sont des données extrapolées pour obtenir une localisation par heure, à partir des données brutes d'ARGOS (extrapolation effectuée par P. Pinet).

```{r, echo = F}
tabb <- readRDS("C:/Users/ccjuhasz/Desktop/SMAC/Projet_publi/X-PTEBAR_argos_JUV/DATA/PTEBAR_JUV_Infos_bilan.rds")

tabb1 <- as.data.frame(tabb[, c('Vessel', 'start', 'deploy', 'n_loc', 'attach', 'burrow', 'ring', 'weight', 'wing', 'remark')])[, -11]

kable(tabb1, align = 'ccccccccc')
```

# Résumé des données argos
```{r, echo = F, class.source = 'test'}
tabb2 <- as.data.frame(tabb[, c('Vessel', 'max_date', 'min_lat', 'max_lat', 'min_lon', 'max_lon', 'max_speed', 'max_dist_km', 'date_loc', 'timing_for_max', 'dist_travel_km', 'duration_trip_day')])[, -13]

tabb2$duration_trip_day <- as.numeric(tabb2$duration_trip_day)
tabb2$timing_for_max <- as.numeric(tabb2$timing_for_max)
tabb2$max_date <- date(tabb2$max_date)
tabb2$date_loc <- date(tabb2$date_loc)


kable(tabb2
      , digits = 2
      , col.names = c('Device', 'Date max', 'Lat min', 'Lat max', 'Lon min', 'Lon max', 'Speed max', 'Dist max', 'Date dist max', 'Nb jr pour max loc', 'Dist tot', 'Duree trajet')
      # align = 'cccccccccccc'
      # , table.attr = 'class=\"striped\"'
      # , format = 'html'
      )
```
# Visualisation des trajets  
  
## Déploiement en 2017  
  
```{r, echo=F}

# map_lines <- readRDS("C:/Users/ccjuhasz/Desktop/SMAC/Projet_publi/X-PTEBAR_argos_JUV/DATA/PTEBAR_JUV_raw_map_lines.rds")
# 
# map_lines

tabb3 <- dplyr::left_join(tabb[, c('Vessel', 'min_date', 'geometry')], tabb2, by = 'Vessel')

# Round numerical values
tabb4 <- cbind(tabb3[, c(1:4, 11)], apply(as.data.frame(tabb3[,c( 'min_lat', 'max_lat', 'min_lon', 'max_lon', 'max_speed', 'max_dist_km', 'timing_for_max', 'dist_travel_km', 'duration_trip_day')])[, -10], 2, round, digit = 2))



tabb4$popup_info <- paste0("<b>PTT</b> ",
                                 tabb4$Vessel,
                                 "<br/>",
                                 "<b>Durée de l'enregistrement </b>",
                                 tabb4$duration_trip_day, " jours",
                                 "<br/>",
                                 "<b>Range latitude [</b>", tabb4$min_lat, "; ", tabb4$max_lat, "<b>]</b>",
                                 "<br/>",
                                 "<b>Range longitude [</b>", tabb4$min_lon, "; ", tabb4$max_lon, "<b>]</b>",
                           "</br>",
                           "<b>Vitesse maximale atteinte </b>", tabb4$max_speed, " unité ?",
                           "</br>",
                           "<b>Distance maximale à la colonie </b>", tabb4$max_dist_km, " atteint km en ", tabb4$timing_for_max, " jours",
                           "</br>",
                           "<b>Distance totale parcourue </b>", tabb4$dist_travel_km, " km")

  mapview(tabb4[year(tabb4$min_date) == 2017,],
          zcol = 'Vessel',
          burst = T,
          homebutton = F,
          popup = popupTable(tabb4[year(tabb4$min_date) == 2017,],
                             zcol = 'popup_info',
                             feature.id = FALSE,
                             row.numbers = FALSE,
                             className = 'mapview-popup'))
```  
  
## Déploiement en 2018  
  
```{r, echo=F}
    mapview(tabb4[year(tabb4$min_date) == 2018,],
          zcol = 'Vessel',
          burst = T,
          homebutton = F,
          popup = popupTable(tabb4[year(tabb4$min_date) == 2018,],
                             zcol = 'popup_info',
                             feature.id = FALSE,
                             row.numbers = FALSE,
                             className = 'mapview-popup'))

# in_run <- readRDS("C:/Users/ccjuhasz/Desktop/SMAC/Projet_publi/X-PTEBAR_argos_JUV/DATA/PTEBAR_JUV_in_Run_points_data.rds")
#   
#   mapview(in_run,
#           zcol = 'Vessel',
#           burst = T,
#           homebutton = F)

```
  
## Points & trajet par individu  
  
```{r, echo=F}
argos <- read.table("C:/Users/ccjuhasz/Desktop/SMAC/Projet_publi/X-PTEBAR_argos_JUV/DATA/PTEBAR_JUV_TRACK_argos_CLEANED.txt",
                 h = T,
                 sep = '\t',
                 dec = '.')[, c(1:4, 9, 17)]

argos$Vessel <- as.factor(argos$Vessel)

argos$Date <- as.POSIXct(argos$Date,
                         format = '%Y-%m-%d %H:%M:%S')
argos$deploy <- as.POSIXct(argos$deploy,
                           format = '%Y-%m-%d %H:%M:%S')

argos.ls <- split(argos, argos$Vessel)
projcrs <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"


plot.ls <- lapply(argos.ls, function(x){
  x.sp <- st_as_sf(x,
                   coords = c('Longitude', 'Latitude'),
                   crs = projcrs)
  x.plot <- mapview(x.sp, legend = F) + mapview(tabb4[tabb4$Vessel == unique(x.sp$Vessel),], legend = F)
  
  x.plot
  
})

# for(p in 1:length(plot.ls)){
#   plot.ls[[p]]
# }

# mapshot() # conversion of mapview object in html
plot.ls[[1]]
plot.ls[[2]]
plot.ls[[3]]
plot.ls[[4]]
plot.ls[[5]]
plot.ls[[6]]
plot.ls[[7]]
plot.ls[[8]]
plot.ls[[9]]
plot.ls[[10]]
plot.ls[[11]]
plot.ls[[12]]
plot.ls[[13]]
plot.ls[[14]]
plot.ls[[15]]

# 



```