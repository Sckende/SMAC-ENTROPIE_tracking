---
title: "PTEBAR-JUV - Data explo"
author: "CCJ"
output:
  html_document:
    toc: true
    number_sections: true
    toc_float: true
---

```{r, include = F}
# Output figure in HTML5
if (knitr::is_html_output()) knitr::knit_hooks$set(
  plot = function(x, options) {
    cap  <- options$fig.cap  # figure caption
    tags <- htmltools::tags
    as.character(tags$figure(
      tags$img(src = x, alt = cap),
      tags$figcaption(cap)
    ))
  }
)

# packages
require(knitr)
require(mapview)
require(leafpop)
require(tidyverse)
require(dplyr)
require(sf)
require(lubridate)
require(htmltools)
```

```{css, echo = F}
.badCode {
background-color: red;
}

.goodCode {
  background-color: green;
}

.striped tbody tr:nth-children(even) {
  font-style: italic;
}
```

# Méthodologie  
 
Duty cycle des balises ARGOS: **10/24**  
Le déploiement des balises ont eu lieu au cours de 2 périodes d'envol (2017 & 2018) sur des juvéniles issus de la colonie de pétrels de Barau du Grand Benare.  
  
Les 6-7 avril 2017, 10 balises ARGOS (5g, avec panneau solaire) ont été installées sur des juvéniles prêts à l'envol (plumage complet). 8 individus ont été équipé à l'aide de tape **Tesa** et de glue **Loctite** et 2 individus, à l'aide d'un harnais en **Teflon**. Les oiseaux se sont envolés entre 2 & 13 jours (moy. 7 jours) après avoir été équipé.  
En 2018, 9 individus ont été équipés entre le 4 & 5 avril, tous avec un harnais en **Teflon**. Ils ont quitté la colonie dans les 2 à 8 jours (moy. 5.5 jours) qui ont suivis.  
  
Les balises ont été programmées pour commencer à enregistrer les localisations AVANT leur déploiement (**start** < **deploy**). Il est donc nécessaire de retirer les localisations enregistrées avant la date de déploiement pour chaque balise.  
  
```{r, echo = F}
tabb <- read.table("C:/Users/ccjuhasz/Desktop/SMAC/Projet_publi/X-PTEBAR_argos_JUV/DATA/PTEBAR_JUV_Infos_deploiement.txt",
                h = T,
                sep = '\t',
                dec = '.')


kable(tabb, align = 'ccccccccc')
```

# Résumé des données argos
```{r, echo = F, class.source = 'test'}
# tabb2 <- as.data.frame(tabb[, c('Vessel', 'max_date', 'min_lat', 'max_lat', 'min_lon', 'max_lon', 'max_speed', 'max_dist_km', 'date_loc', 'timing_for_max', 'dist_travel_km', 'duration_trip_day')])[, -13]
# 
# tabb2$duration_trip_day <- as.numeric(tabb2$duration_trip_day)
# tabb2$timing_for_max <- as.numeric(tabb2$timing_for_max)
# tabb2$max_date <- date(tabb2$max_date)
# tabb2$date_loc <- date(tabb2$date_loc)
# 
# 
# kable(tabb2
#       , digits = 2
#       , col.names = c('Device', 'Date max', 'Lat min', 'Lat max', 'Lon min', 'Lon max', 'Speed max', 'Dist max', 'Date dist max', 'Nb jr pour max loc', 'Dist tot', 'Duree trajet')
#       # align = 'cccccccccccc'
#       # , table.attr = 'class=\"striped\"'
#       # , format = 'html'
#       )
```
# Visualisation des trajets  
  
## Déploiement en 2017  
  
```{r, echo=F}

# map_lines <- readRDS("C:/Users/ccjuhasz/Desktop/SMAC/Projet_publi/X-PTEBAR_argos_JUV/DATA/PTEBAR_JUV_raw_map_lines.rds")
# 
# map_lines

tabb3 <- dplyr::left_join(tabb[, c('Vessel', 'min_date', 'geometry')], tabb2, by = 'Vessel')

# Round numerical values
tabb4 <- cbind(tabb3[, c(1:4, 11)], apply(as.data.frame(tabb3[,c( 'min_lat', 'max_lat', 'min_lon', 'max_lon', 'max_speed', 'max_dist_km', 'timing_for_max', 'dist_travel_km', 'duration_trip_day')])[, -10], 2, round, digit = 2))



tabb4$popup_info <- paste0("<b>PTT</b> ",
                                 tabb4$Vessel,
                                 "<br/>",
                                 "<b>Durée de l'enregistrement </b>",
                                 tabb4$duration_trip_day, " jours",
                                 "<br/>",
                                 "<b>Range latitude [</b>", tabb4$min_lat, "; ", tabb4$max_lat, "<b>]</b>",
                                 "<br/>",
                                 "<b>Range longitude [</b>", tabb4$min_lon, "; ", tabb4$max_lon, "<b>]</b>",
                           "</br>",
                           "<b>Vitesse maximale atteinte </b>", tabb4$max_speed, " unité ?",
                           "</br>",
                           "<b>Distance maximale à la colonie </b>", tabb4$max_dist_km, " atteint km en ", tabb4$timing_for_max, " jours",
                           "</br>",
                           "<b>Distance totale parcourue </b>", tabb4$dist_travel_km, " km")

  mapview(tabb4[year(tabb4$min_date) == 2017,],
          zcol = 'Vessel',
          burst = T,
          homebutton = F,
          popup = popupTable(tabb4[year(tabb4$min_date) == 2017,],
                             zcol = 'popup_info',
                             feature.id = FALSE,
                             row.numbers = FALSE,
                             className = 'mapview-popup'))
```  
  
## Déploiement en 2018  
  
```{r, echo=F}
    mapview(tabb4[year(tabb4$min_date) == 2018,],
          zcol = 'Vessel',
          burst = T,
          homebutton = F,
          popup = popupTable(tabb4[year(tabb4$min_date) == 2018,],
                             zcol = 'popup_info',
                             feature.id = FALSE,
                             row.numbers = FALSE,
                             className = 'mapview-popup'))

# in_run <- readRDS("C:/Users/ccjuhasz/Desktop/SMAC/Projet_publi/X-PTEBAR_argos_JUV/DATA/PTEBAR_JUV_in_Run_points_data.rds")
#   
#   mapview(in_run,
#           zcol = 'Vessel',
#           burst = T,
#           homebutton = F)

```
  
## Points & trajet par individu  
  
```{r, echo=F}

argos <- readRDS("C:/Users/ccjuhasz/Desktop/SMAC/Projet_publi/X-PTEBAR_argos_JUV/DATA/PTEBAR_JUV_Pinet_data_CLEANED.rds")


argos.track <- do.call('rbind', argos) %>% group_by(Vessel) %>%  summarize(do_union = F) %>% st_cast('LINESTRING')

  x.plot <- lapply(argos, function(x){
    
    mapview(x,
        zcol = 'odd',
        col.regions = c('dodgerblue4', 'olivedrab'),
        popup = 'point.group',
        legend = F,
        layer.name = unique(as.character(x$Vessel))) + mapview(argos.track[argos.track$Vessel == unique(as.character(x$Vessel)),],
                                                               color = 'darkgrey',
                                                               layer.name = 'Track')
    
  })

  
x.plot[[1]]
x.plot[[2]]
x.plot[[3]]
x.plot[[4]]
x.plot[[5]]
x.plot[[6]]
x.plot[[7]]
x.plot[[8]]
x.plot[[9]]
x.plot[[10]]
x.plot[[11]]
x.plot[[12]]
x.plot[[13]]
x.plot[[14]]
x.plot[[15]]
```